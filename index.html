<html>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <style> 
    rect { stroke: black; }
    /* Tooltip style code borrowed from Lecture 8-3-3 */
    #tooltip {
        opacity: 0;
        position: absolute;
        text-align: center;
        width: 60px;
        height: 40px;
        background: white;
        border: 0px;
        /* Pointer Events: https://www.w3schools.com/cssref/css3_pr_pointer-events.php */
        pointer-events: none;
    }
    body {
        font-family: "Tahoma";
    }
    g {
        font-family: "Tahoma";
    }
    </style>

    <body>
    <h1 >Average FAO Food Price Index by Decade</h1>
    <p>Use the following visualization below to see how the food price index has changed over the years!</p>
    <h3>Understanding the Price Index</h3>
    <p>The price index represent the price of the item relative to its price average from 2014-2016 [1].</p>
    <p>For example, a price index of 60 represents a 40% decrease in price relative to the price average from 2014-2016. Moreover, a price index of 120 represents a 20% increase in price relative to the price average from 2014-2016.</p>
    <br><br>
    <button onclick="previous()" disabled="True" id="prev_btn">Previous</button>
    <button onclick="next()" id="next_btn">Next</button>
    <br>
    <div id="tooltip" opacity="0"></div>
    <p id="title">Avg. Food Price Index, 1990s</p>
    <svg width="200" height="200" display="block"></svg>
    <h3>Sources</h3>
    <p>[1] https://www.fao.org/worldfoodsituation/foodpricesindex/en/</p>
    <p>[2] https://zootecnicainternational.com/featured/dynamics-usa-broiler-industry-1990-2019/</p>
    <p>[3] https://ers.usda.gov/sites/default/files/_laserfiche/outlooks/40463/12274_wrs0801_1_.pdf </p>
    <p>[4] https://www.ers.usda.gov/amber-waves/2011/september/commodity-price-spike#:~:text=Longer%20Term%20Trends%20Create%20Conditions,and%20growing%20global%20biofuel%20production. </p>
    <script>
        var data;
        var data2
        let decade_index = 0;
        d3.csv("food_indices_avg_year_named.csv").then(function(d) {data2 = d;
            d3.csv("food_indices_avg_decade_90s_10s.csv").then(function(d) {data = d; updateBarGraph(decade_index);});
            });
        const categories = ["Meat", "Dairy", "Cereals", "Oils", "Sugar"];
        const margin = 50;
        const colors = [ "violet", "mintcream", "pink", "lightyellow", "ivory"]
        var x = d3.scaleBand().domain(categories).range([0, 400]);
        var y = d3.scaleLinear().domain([0, 110.459166666667]).range([200, 0]);

        const tooltip = d3.select("#tooltip");
        

        function updateBarGraph(index) {
            let decade_data = data[index];
            var working_data = [];
            for (var i = 0; i < categories.length; i++) {
                var temp = {}
                temp.type = categories[i];
                temp.value = decade_data[categories[i]];
                working_data.push(temp)
            }
            console.log(working_data);
            title = document.getElementById("title");
            switch(index) {
                case 0:
                    title.innerHTML = "Avg. Food Price Index, 1990s";
                    break;
                case 1:
                    title.innerHTML = "Avg. Food Price Index, 2000s";
                    break;
                case 2:
                    title.innerHTML = "Avg. Food Price Index, 2010s";
                    break;
            }

            d3.select("svg").selectAll("g").remove();


            d3.select("svg")
            .attr("width", 800 + 2* margin)
            .attr("height", 200 + 2* margin)
            .append("g")
            .attr("transform", "translate("+margin+", "+margin+")")
            .selectAll("rect")
            .data(working_data)
            .enter().append("rect")
            .attr("x", function (d, i) {return x(d.type);})
            .attr("width", x.bandwidth())
            .attr("fill", function(d, i) {return colors[i];})
            .attr("y", function(d, i) {return y(d.value);})
            .attr("height", function(d, i) {return 200 - parseFloat(y(d.value));})

            .on("click", function(d, i) {
                drawYearGraph(categories[i], decade_index, colors[i]);
            })
            /* Tooltip code borrowed from Lecture 8-3-3 */
            .on("mouseover", function(d, i) {
                // cursor code: https://stackoverflow.com/questions/36326683/d3-js-how-can-i-set-the-cursor-to-hand-when-mouseover-these-elements-on-svg-co
                d3.select(this).style("cursor", "pointer");

                tooltip.style("opacity", 1)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY) + "px")
                .html("Value: " + parseFloat(d.value).toFixed(2))
            })
            .on("mouseout", function(d, i) {
                tooltip.style("opacity", 0);
                d3.select(this).style("cursor", "default");

            });

            d3.select("svg")
            .append("g")
            .attr("transform", "translate("+margin+", "+margin+")")
            .call(d3.axisLeft(y));

            d3.select("svg")
            .append("g")
            .attr("transform", "translate("+margin+", "+(200+margin)+")")
            .call(d3.axisBottom(x));

            d3.select("svg").selectAll(".annotation").remove();

            switch(index) {
                case 0:
                    d3.select("svg")
                    .append("g")
                    .append("text")
                    .attr("id", "annotation")
                    .attr("x", 475)
                    .attr("y", 50)
                    .attr("font-size", 14)
                    .text("Increase in broiler meat production in the 90s brought");
                    d3.select("svg")
                    .append("g")
                    .append("text")
                    .attr("id", "annotation")
                    .attr("x", 475)
                    .attr("y", 65)
                    .attr("font-size", 14)
                    .text("the price index of Meat down to its lowest point [2].")
                    break;
                case 1:
                    d3.select("svg")
                    .append("g")
                    .append("text")
                    .attr("id", "annotation")
                    .attr("x", 475)
                    .attr("y", 50)
                    .attr("font-size", 14)
                    .text("Increase in agriculture production costs, bad weather conditions,");
                    d3.select("svg")
                    .append("g")
                    .append("text")
                    .attr("id", "annotation")
                    .attr("x", 475)
                    .attr("y", 65)
                    .attr("font-size", 14)
                    .text("and rising energy prices raised the prices of most commodities,")
                    d3.select("svg")
                    .append("g")
                    .append("text")
                    .attr("id", "annotation")
                    .attr("x", 475)
                    .attr("y", 80)
                    .attr("font-size", 14)
                    .text("especially in 2006 and 2007 [3].")
                    break;
                case 2:
                    title.innerHTML = "Avg. Food Price Index, 2010s";
                    title.innerHTML = "Avg. Food Price Index, 2000s";
                    d3.select("svg")
                    .append("g")
                    .append("text")
                    .attr("id", "annotation")
                    .attr("x", 475)
                    .attr("y", 50)
                    .attr("font-size", 14)
                    .text("The rise in global population, consumption of animal products,");
                    d3.select("svg")
                    .append("g")
                    .append("text")
                    .attr("id", "annotation")
                    .attr("x", 475)
                    .attr("y", 65)
                    .attr("font-size", 14)
                    .text("biofuel production, and energy prices dramatically raised the")
                    d3.select("svg")
                    .append("g")
                    .append("text")
                    .attr("id", "annotation")
                    .attr("x", 475)
                    .attr("y", 80)
                    .attr("font-size", 14)
                    .text("prices of all commodities [4].")
                    break;
            }



        }

        function drawYearGraph(category, idx, color) {
            var year_data = [];
            var values = [];
            var years = [];
            for (var i = 10 * idx; i < 10 * (idx+1); i++) {
                var temp = {};
                temp.year = parseInt(data2[i]["Year"]);
                temp.value = parseFloat(data2[i][category]);
                values.push(temp.value)
                years.push(temp.year)
                year_data.push(temp)
            }
            console.log(values);

            var x = d3.scaleBand().domain(years).range([0, 400]);
            // max function: https://observablehq.com/@d3/d3-extent
            var y = d3.scaleLinear().domain([0, d3.max(values)]).range([200, 0]);
            console.log([year_data[0].year, year_data[year_data.length-1].year]);

            d3.select("svg").select("#years").remove();
            d3.select("svg").select("#year_axis").remove();

            d3.select("svg").select("#year_axis2").remove();
            d3.select("svg").select("#title").remove();



            d3.select("svg")
            .attr("width", 800 + 2* margin)
            .attr("height", 500 + 2* margin)
            .append("g")
            .attr("id", "years")
            .attr("transform", "translate("+margin+", "+(300+margin)+")")
            .selectAll("rect")
            .data(year_data)
            .enter().append("rect")
            .attr("x", function (d, i) {return x(d.year);})
            .attr("width", x.bandwidth())
            .attr("y", function(d, i) {return y(d.value);})
            .attr("height", function(d, i) {return 200 - parseFloat(y(d.value));})
            .attr("fill", color)
            /* Tooltip code borrowed from Lecture 8-3-3 */
            .on("mouseover", function(d, i) {
                // cursor code: https://stackoverflow.com/questions/36326683/d3-js-how-can-i-set-the-cursor-to-hand-when-mouseover-these-elements-on-svg-co
                d3.select(this).style("cursor", "pointer");

                tooltip.style("opacity", 1)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY) + "px")
                .html("Value: " + parseFloat(d.value).toFixed(2))
            })
            .on("mouseout", function(d, i) {
                tooltip.style("opacity", 0);
                d3.select(this).style("cursor", "default");

            });

            d3.select("svg")
            .append("g")
            .attr("id", "year_axis")
            .attr("transform", "translate("+margin+", "+(300 + margin)+")")
            .call(d3.axisLeft(y));

            d3.select("svg")
            .append("g")
            .attr("id", "year_axis2")
            .attr("transform", "translate("+margin+", "+(500+margin)+")")
            .call(d3.axisBottom(x));

            // Text Syntax: https://stackoverflow.com/questions/20644415/d3-appending-text-to-a-svg-rectangle
            d3.select("svg")
            .append("g")
            .attr("id", "title")
            .append("text")
            .attr("x", 0)
            .attr("y", 300)
            .text( category + " Price Index, " + (1990 + 10 * idx) + " - " + (1999 + 10 * idx));

        }

        var prev_btn = document.getElementById("prev_btn");
        var next_btn = document.getElementById("next_btn");
        function previous() {
            decade_index -= 1;
            if (decade_index == 0) {
                prev_btn.disabled = true;
            } else {
                prev_btn.disabled = false;
            }
            if (next_btn.disabled) {
                next_btn.disabled = !(next_btn.disabled);
            }

            updateBarGraph(decade_index);

        }
        function next() {
            decade_index += 1;
            if (decade_index == 2) {
                next_btn.disabled = true;
            } else {
                next_btn.disabled = false;
            }
            if (prev_btn.disabled) {
                prev_btn.disabled = !(prev_btn.disabled);
            }
            updateBarGraph(decade_index)           
        }
    </script>
</body>
</html>
